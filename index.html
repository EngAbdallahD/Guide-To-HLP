<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Guide to HLP Machines</title>
<style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #23313e 0%, #2c3e50 100%);
        min-height: 100vh;
        color: #ecf0f1;
        overflow-x: hidden;
        font-size: 14px;
    }

    /* --- Login Background Slideshow --- */
    #loginBackgroundSlideshow { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; overflow: hidden; }
    .slide { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-size: cover; background-position: center center; opacity: 0; animation: fadeSlide 49s infinite; }
    .slide:nth-child(1) { background-image: url('bg1.jpg'); animation-delay: 0s; }
    .slide:nth-child(2) { background-image: url('bg2.jpg'); animation-delay: 7s; }
    .slide:nth-child(3) { background-image: url('bg3.jpg'); animation-delay: 14s; }
    .slide:nth-child(4) { background-image: url('bg4.jpg'); animation-delay: 21s; }
    .slide:nth-child(5) { background-image: url('bg5.jpg'); animation-delay: 28s; }
    .slide:nth-child(6) { background-image: url('bg6.jpg'); animation-delay: 35s; }
    .slide:nth-child(7) { background-image: url('bg7.jpg'); animation-delay: 42s; }
    @keyframes fadeSlide { 0% { opacity: 0; transform: scale(1.05) rotate(0.5deg); } 10% { opacity: 1; transform: scale(1) rotate(0deg); } 14.28% { opacity: 1; transform: scale(1) rotate(0deg); } 24.28% { opacity: 0; transform: scale(1.05) rotate(-0.5deg); } 25% { opacity: 0; } 100% { opacity: 0; } }

    /* --- General Containers & Login --- */
    .container { max-width: 1200px; margin: 0 auto; padding: 20px 15px; }
    .login-container, .main-container, .manager-panel-container { background: rgba(52, 73, 94, 0.88); border-radius: 15px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.1); position: relative; z-index: 1; }
    .login-container { max-width: 400px; margin: 80px auto; text-align: center; }
    .logo { margin-bottom: 15px; }
    .logo img { max-width: 180px; height: auto; display: block; margin: 0 auto 10px auto; }
    .login-container h2 { text-align: center; margin-bottom: 5px; color: #3498db; }
    .login-container p { text-align: center; }
    
    /* --- Forms & Inputs (including password toggle) --- */
    .form-group { margin-bottom: 15px; text-align: left; }
    .form-group label { display: block; margin-bottom: 5px; color: #bdc3c7; font-weight: 500; }
    .password-wrapper { position: relative; display: flex; align-items: center; }
    .password-wrapper input[type="password"], .password-wrapper input[type="text"] { padding-right: 45px !important; /* Space for toggle */ width: 100%; }
    .toggle-password { position: absolute; right: 1px; top: 1px; bottom: 1px; width: 40px; background: rgba(69, 90, 100, 0.7); border: none; color: #bdc3c7; cursor: pointer; font-size: 1.2em; display: flex; align-items: center; justify-content: center; border-radius: 0 7px 7px 0; }
    .toggle-password:hover { color: #3498db; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #34495e; border-radius: 8px; background: rgba(44, 62, 80, 0.8); color: #ecf0f1; font-size: inherit; transition: border-color 0.3s ease, box-shadow 0.3s ease; }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #3498db; box-shadow: 0 0 10px rgba(52,152,219,0.3); }

    /* --- Buttons --- */
    .btn { background: linear-gradient(45deg, #3498db, #2980b9); color: white; padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer; font-size: 0.95em; font-weight: 500; transition: all 0.3s ease; margin: 5px; text-decoration: none; display: inline-block; line-height: 1.4; }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(52,152,219,0.4); }
    .btn-secondary { background: linear-gradient(45deg, #95a5a6, #7f8c8d); }
    .btn-danger { background: linear-gradient(45deg, #e74c3c, #c0392b); }
    .btn-success { background: linear-gradient(45deg, #27ae60, #229954); }

    /* --- Header & User Info (Centered Title) --- */
    .header { display: flex; justify-content: center; align-items: center; position: relative; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); min-height: 50px; }
    .header h1 { font-size: 1.5em; text-align: center; margin: 0; color: #3498db; padding: 0 50px; /* Padding to avoid visual overlap with user-info */ }
    .user-info { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; position: absolute; right: 0px; top: 50%; transform: translateY(-50%); }
    .user-role { padding: 4px 10px; font-size: 0.8em; border: 1px solid; border-radius: 20px; }

    /* --- Search Section (Mobile First) --- */
    .search-section { margin-bottom: 20px; }
    .search-section h3 { color: #3498db; text-align: center; margin-bottom: 15px; }
    .search-box { display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; }
    .search-box select, .search-box input[type="text"], .search-box .btn { width: 100%; max-width: none; }
    
    /* --- Machine Grid (Mobile First) --- */
    .engine-grid { display: grid; grid-template-columns: 1fr; gap: 15px; margin-top: 15px; }
    .engine-card { background: rgba(44,62,80,0.8); border-radius: 12px; padding: 15px; border: 1px solid rgba(255,255,255,0.1); transition: transform 0.3s ease, box-shadow 0.3s ease; display: flex; flex-direction: column; justify-content: space-between; }
    .engine-card-clickable-area { cursor: pointer; }
    .engine-card:hover { transform: translateY(-2px); box-shadow: 0 6px 18px rgba(0,0,0,0.2); }
    .engine-id { font-size: 1.2em; font-weight: bold; color: #3498db; margin-bottom: 8px; }
    .engine-info { display: grid; grid-template-columns: 1fr; gap: 8px; margin-bottom: 10px; }
    .info-item { background: rgba(52,73,94,0.5); padding: 6px; border-radius: 5px; font-size: 0.9em; word-wrap: break-word; }
    .info-label { color: #bdc3c7; font-weight: 500; }
    .info-value { color: #ecf0f1; margin-top: 2px; }
    .engine-image { width: 100%; height: 150px; object-fit: cover; border-radius: 8px; margin-bottom: 10px; background: rgba(52,73,94,0.3); display: flex; align-items: center; justify-content: center; color: #7f8c8d; }
    .engine-image img { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; }
    .engine-card-actions { margin-top: 10px; text-align: right; display: flex; gap: 8px; justify-content: flex-end; }
    .engine-card-actions .btn { padding: 6px 12px; font-size: 0.85em; }

    /* --- Admin Form & Manager Panel (Mobile First) --- */
    .admin-form, .manager-panel-container { background: rgba(44,62,80,0.7); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid rgba(52,152,219,0.3); }
    .admin-form h3, .manager-panel-container h3 { color: #3498db; text-align: center; margin-bottom: 20px; font-size: 1.3em; }
    .admin-form fieldset, .manager-panel-container fieldset { border: 1px solid rgba(52,152,219,0.4); border-radius: 8px; padding: 15px; margin-bottom: 15px; }
    .admin-form legend, .manager-panel-container legend { color: #3498db; font-weight: bold; padding: 0 8px; margin-left: 8px; font-size: 1em; }
    .form-row { display: grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 10px; }
    .form-row .form-group, .admin-form > .form-group { margin-bottom: 0; }
    .form-row-single { grid-column: 1 / -1; }

    /* --- General Helper Classes & Other --- */
    .hidden { display: none !important; }
    #loginBackgroundSlideshow.hidden { display: none !important; }
    .no-results { text-align: center; color: #7f8c8d; font-size: 1em; margin-top: 30px; padding: 15px;}
    .stats-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px,1fr)); gap: 10px; margin-bottom: 20px; }
    .stat-card { padding: 15px; background: rgba(52,152,219,0.2); border-radius: 10px; text-align: center; border: 1px solid #3498db; }
    .stat-number { font-size: 1.8em; font-weight: bold; color: #3498db;}
    .stat-label { margin-top: 3px; font-size: 0.9em; color: #bdc3c7;}
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    .modal.hidden { display: none !important; }
    .modal-content { background: #2c3e50; padding: 20px; border-radius: 15px; max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto; }
    .modal-content .info-item { margin-bottom: 5px;}
    .modal-section-title { color: #3498db; font-weight: bold; margin-top: 15px; margin-bottom: 10px; font-size: 1em; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px;}
    #credentialUpdateStatus { margin-top: 10px; font-weight: 500; font-size: 0.9em; text-align: center; }

    /* --- Media Queries for Larger Screens --- */
    @media (min-width: 600px) {
        body { font-size: 15px; }
        .container { padding: 20px; }
        .login-container { padding: 30px; }
        .main-container, .manager-panel-container, .admin-form { padding: 25px; }
        .header h1 { font-size: 1.8em; padding: 0 100px; }
        .search-box { flex-direction: row; }
        .search-box select, .search-box input[type="text"] { width: auto; }
        .search-box input[type="text"] { flex: 1; }
        .search-box select { max-width: 180px; }
        .engine-grid { grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); }
        .engine-info { grid-template-columns: 1fr 1fr; }
        .form-row { grid-template-columns: repeat(auto-fit, minmax(230px,1fr)); }
    }
    @media (min-width: 992px) {
        body { font-size: 16px; }
        .header h1 { padding: 0 150px; }
        .engine-grid { grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); }
        .search-box select { max-width: 200px; }
        .form-row { gap: 15px; margin-bottom: 15px; }
    }
</style>
</head>
<body>

<div id="loginBackgroundSlideshow">
    <div class="slide"></div> <div class="slide"></div> <div class="slide"></div>
    <div class="slide"></div> <div class="slide"></div> <div class="slide"></div> <div class="slide"></div>
</div>

<div id="loginScreen" class="login-container">
    <div class="logo"><img src="arab_potash_logo.png" alt="Guide to HLP Machines Logo"></div>
    <h2>Guide to HLP Machines</h2>
    <p style="margin-bottom: 30px; color: #7f8c8d;">Factory Management Portal</p>
    <div class="form-group"><label for="loginUsername">Username</label><input type="text" id="loginUsername" placeholder="Enter username"></div>
    <div class="form-group">
        <label for="loginPassword">Password</label>
        <div class="password-wrapper">
            <input type="password" id="loginPassword" placeholder="Enter password">
            <button type="button" class="toggle-password" onclick="togglePasswordVisibility('loginPassword', this)">👁️</button>
        </div>
    </div>
    <button class="btn" onclick="handleLogin()">Login</button>
    <div id="loginErrorDisplay" style="color: #e74c3c; margin-top: 15px; display: none;">Invalid credentials.</div>
</div>

<div id="mainApp" class="container hidden">
    <div class="main-container">
        <div class="header">
            <h1>🏭 Guide to HLP Machines</h1>
            <div class="user-info">
                <div class="user-role" id="userRoleDisplay">User</div>
                <span id="currentUserDisplay">HLP</span>
                <button id="userManagementBtn" class="btn btn-secondary hidden" onclick="toggleManagerPanel()">User Management</button>
                <button class="btn btn-secondary" onclick="handleLogout()">Logout</button>
            </div>
        </div>

        <div id="managerControlPanel" class="manager-panel-container hidden">
            <h3>User Account Management</h3>
            <fieldset><legend>User Credentials</legend><div class="form-row">
                <div class="form-group"><label for="manageUserUsername">Username (Read-only)</label><input type="text" id="manageUserUsername" readonly></div>
                <div class="form-group"><label for="manageUserPassword">New Password</label><div class="password-wrapper"><input type="password" id="manageUserPassword" placeholder="Enter new password"><button type="button" class="toggle-password" onclick="togglePasswordVisibility('manageUserPassword', this)">👁️</button></div></div>
            </div></fieldset>
            <fieldset><legend>Administrator Credentials</legend><div class="form-row">
                <div class="form-group"><label for="manageAdminUsername">Username (Read-only)</label><input type="text" id="manageAdminUsername" readonly></div>
                <div class="form-group"><label for="manageAdminPassword">New Password</label><div class="password-wrapper"><input type="password" id="manageAdminPassword" placeholder="Enter new password"><button type="button" class="toggle-password" onclick="togglePasswordVisibility('manageAdminPassword', this)">👁️</button></div></div>
            </div></fieldset>
            <button class="btn btn-success" onclick="saveManagedCredentials()">Save Credential Changes</button>
            <div id="credentialUpdateStatus"></div>
        </div>

        <div id="statsSection" class="stats-section hidden">
            <div class="stat-card"><div class="stat-number" id="totalMachinesDisplay">0</div><div class="stat-label">Total Machines</div></div>
            <div class="stat-card"><div class="stat-number" id="activeMachinesDisplay">0</div><div class="stat-label">Active Machines</div></div>
            <div class="stat-card"><div class="stat-number" id="maintenanceMachinesDisplay">0</div><div class="stat-label">Maintenance Machines</div></div>
        </div>
        
        <div id="adminFormSection" class="hidden">
            <div class="admin-form">
            <h3 style="margin-bottom: 20px; color: #3498db;">Add New Machine Data</h3>
            <fieldset><legend>Core Identifiers</legend><div class="form-row">
                <div class="form-group"><label for="machineIdInput">Machine ID *</label><input type="text" id="machineIdInput" placeholder="e.g., MC-SYS-001"></div>
                <div class="form-group"><label for="panelNumberInput">Panel Number</label><input type="text" id="panelNumberInput" placeholder="Panel ID"></div>
            </div></fieldset>
            <fieldset><legend>Equipment Information</legend><div class="form-row">
                <div class="form-group"><label for="equipTagNoInput">Equipment Tag No.</label><input type="text" id="equipTagNoInput" placeholder="Tag Number"></div>
                <div class="form-group"><label for="equipDescInput">Equipment Description</label><input type="text" id="equipDescInput" placeholder="Description"></div>
            </div></fieldset>
            <fieldset><legend>Motor MCC Data</legend>
                <div class="form-row"><div class="form-group"><label for="switchRoomNoInput">Switch Room No.</label><input type="text" id="switchRoomNoInput"></div><div class="form-group"><label for="mccInput">MCC</label><input type="text" id="mccInput"></div></div>
                <div class="form-row"><div class="form-group"><label for="mccLocationInput">MCC Location</label><input type="text" id="mccLocationInput"></div><div class="form-group"><label for="mccTypicalInput">MCC Typical</label><input type="text" id="mccTypicalInput"></div></div>
                <div class="form-row"><div class="form-group"><label for="profibusAddressInput">Profibus Address</label><input type="text" id="profibusAddressInput"></div><div class="form-group"><label for="runningAppInput">Running Application</label><input type="text" id="runningAppInput"></div></div>
                <div class="form-row"><div class="form-group"><label for="powerKWmccInput">Power (KW)</label><input type="number" step="0.01" id="powerKWmccInput"></div><div class="form-group"><label for="currentAMPmccInput">Current (AMP)</label><input type="number" step="0.01" id="currentAMPmccInput"></div></div>
                <div class="form-row"><div class="form-group"><label for="systemCabinetInput">System Cabinet</label><input type="text" id="systemCabinetInput"></div><div class="form-group"><label for="segmentNoInput">Segment No.</label><input type="text" id="segmentNoInput"></div></div>
                <div class="form-row"><div class="form-group"><label for="redundantNoInput">Redundant No.</label><input type="text" id="redundantNoInput"></div><div class="form-group"><label for="voltagemccInput">Voltage</label><input type="text" id="voltagemccInput"></div></div>
                <div class="form-row"><div class="form-group"><label for="powerCableInput">Power Cable</label><input type="text" id="powerCableInput"></div><div class="form-group"><label for="fieldControlCableInput">Field Control Cable</label><input type="text" id="fieldControlCableInput"></div></div>
                <div class="form-row"><div class="form-group"><label for="rtdCableInput">RTD Cable</label><input type="text" id="rtdCableInput"></div><div class="form-group"><label for="heaterCableInput">Heater Cable</label><input type="text" id="heaterCableInput"></div></div>
                <div class="form-row"><div class="form-group"><label for="estimatedLengthmccInput">Estimated Length</label><input type="text" id="estimatedLengthmccInput"></div><div class="form-group"><label for="mvCtRatiomccInput">MV CT Ratio</label><input type="text" id="mvCtRatiomccInput"></div></div>
                <div class="form-row"><div class="form-group form-row-single"><label for="hhmFusesSibamccInput">HHM-Fuses SIBA</label><input type="text" id="hhmFusesSibamccInput"></div></div>
            </fieldset>
            <fieldset><legend>Motor Name Plate</legend>
                <div class="form-row"><div class="form-group"><label for="motorDescriptionNpInput">Motor Description</label><input type="text" id="motorDescriptionNpInput"></div><div class="form-group"><label for="typeNpInput">Type</label><input type="text" id="typeNpInput"></div></div>
                <div class="form-row"><div class="form-group"><label for="frameNpInput">Frame</label><input type="text" id="frameNpInput"></div><div class="form-group"><label for="flaNpInput">FLA</label><input type="text" id="flaNpInput"></div></div>
                <div class="form-row"><div class="form-group"><label for="rpmNpInput">RPM</label><input type="number" id="rpmNpInput"></div><div class="form-group"><label for="hpKwNpInput">HP/KW</label><input type="text" id="hpKwNpInput"></div></div>
                <div class="form-row"><div class="form-group"><label for="manufacturerNpInput">Manufacturer</label><input type="text" id="manufacturerNpInput"></div><div class="form-group"><label for="voltsNpInput">Volts</label><input type="text" id="voltsNpInput"></div></div>
                <div class="form-row"><div class="form-group"><label for="couplingTypeNpInput">Coupling Type</label><input type="text" id="couplingTypeNpInput"></div><div class="form-group"><label for="mountingTypeNpInput">Mounting Type</label><input type="text" id="mountingTypeNpInput"></div></div>
                <div class="form-row"><div class="form-group"><label for="jBoxSideNpInput">J.Box Side</label><input type="text" id="jBoxSideNpInput"></div><div class="form-group"><label for="deBearingNpInput">DE-Bearing</label><input type="text" id="deBearingNpInput"></div></div>
                <div class="form-row"><div class="form-group form-row-single"><label for="ndeBearingNpInput">NDE-Bearing</label><input type="text" id="ndeBearingNpInput"></div></div>
                <div class="form-row"><div class="form-group form-row-single"><label for="noteNpInput">Note (Name Plate)</label><textarea id="noteNpInput" rows="2"></textarea></div></div>
            </fieldset>
            <fieldset><legend>Motor Replacements History</legend>
                <div class="form-row"><div class="form-group"><label for="replacementDate1Input">Date 1</label><input type="date" id="replacementDate1Input"></div><div class="form-group"><label for="replacementDate2Input">Date 2</label><input type="date" id="replacementDate2Input"></div></div>
                <div class="form-row"><div class="form-group"><label for="replacementDate3Input">Date 3</label><input type="date" id="replacementDate3Input"></div><div class="form-group"><label for="replacementDate4Input">Date 4</label><input type="date" id="replacementDate4Input"></div></div>
            </fieldset>
            <fieldset><legend>Breakers Related To</legend>
                <p>Breaker 1:</p><div class="form-row"><div class="form-group"><label for="breakerEquipDesc1Input">Eq. Desc. 1</label><input type="text" id="breakerEquipDesc1Input"></div><div class="form-group"><label for="breakerEquipTag1Input">Eq. Tag 1</label><input type="text" id="breakerEquipTag1Input"></div><div class="form-group"><label for="breakerMccLocation1Input">MCC Loc. 1</label><input type="text" id="breakerMccLocation1Input"></div></div><hr>
                <p>Breaker 2:</p><div class="form-row"><div class="form-group"><label for="breakerEquipDesc2Input">Eq. Desc. 2</label><input type="text" id="breakerEquipDesc2Input"></div><div class="form-group"><label for="breakerEquipTag2Input">Eq. Tag 2</label><input type="text" id="breakerEquipTag2Input"></div><div class="form-group"><label for="breakerMccLocation2Input">MCC Loc. 2</label><input type="text" id="breakerMccLocation2Input"></div></div>
            </fieldset>
            <fieldset><legend>Additional Information (Listed)</legend>
                <div class="form-row"><div class="form-group"><label for="motNoAddInput">MOT.No.</label><input type="text" id="motNoAddInput"></div><div class="form-group"><label for="assetNoAddInput">Asset No.</label><input type="text" id="assetNoAddInput"></div></div>
                <div class="form-row"><div class="form-group form-row-single"><label for="hlpFeedbackNoteAddInput">HLP Feedback</label><textarea id="hlpFeedbackNoteAddInput" rows="2"></textarea></div></div>
            </fieldset>
            <fieldset><legend>System & Maintenance</legend><div class="form-row">
                <div class="form-group"><label for="statusInput">Status</label><select id="statusInput"><option value="Active">Active</option><option value="Maintenance">Maintenance</option><option value="Inactive">Inactive</option></select></div>
            </div><div class="form-group"><label for="generalNotesInput">General Notes</label><textarea id="generalNotesInput" rows="3"></textarea></div>
            <div class="form-group"><label for="machineImageInput">Machine Image</label><input type="file" id="machineImageInput" accept="image/*" onchange="previewImage(event)"><div id="imagePreview" style="margin-top: 10px;"></div></div></fieldset>
            <button class="btn btn-success" onclick="handleAddMachine()">Add Machine Data</button>
            <button class="btn btn-secondary" onclick="clearAdminForm()">Clear Form</button>
            </div>
        </div>

        <div class="search-section">
            <h3 style="margin-bottom: 15px;">Search Machines</h3>
            <div class="search-box">
                <select id="searchFieldSelect" onchange="handleSearchMachines()"><option value="all">All Fields</option><option value="id">Machine ID</option><option value="equipTagNo">Eq. Tag No.</option><option value="equipDesc">Eq. Description</option><option value="panelNumber">Panel No.</option><option value="mccLocation">MCC Location</option><option value="motorDescription_np">Motor Desc. (NP)</option><option value="manufacturer_np">Manufacturer (NP)</option><option value="switchRoomNo">Switch Room</option><option value="mcc">MCC ID</option><option value="status">Status</option></select>
                <input type="text" id="searchInputText" placeholder="Enter search term..." onkeyup="handleSearchMachines()">
                <button class="btn" onclick="handleSearchMachines()">Search</button>
                <button class="btn btn-secondary" onclick="handleShowAllMachines()">Show All</button>
            </div>
        </div>
        <div id="machinesGrid" class="engine-grid"></div>
        <div id="noResultsDisplay" class="no-results hidden">No machines found.</div>
    </div>
</div>

<div id="machineDetailModal" class="modal hidden">
    <div class="modal-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 id="modalTitleDisplay">Machine Details</h3><button class="btn btn-secondary" onclick="closeMachineDetailModal()">Close</button></div>
        <div id="modalContentDisplay" style="display: grid; gap: 10px;"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
    import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getStorage, ref as storageRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "YOUR_API_KEY", //  REPLACE WITH YOUR FIREBASE CONFIG
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID",
      measurementId: "YOUR_MEASUREMENT_ID" 
    };

    const app = initializeApp(firebaseConfig);
    try { getAnalytics(app); } catch(e) { console.warn("Firebase Analytics init failed:", e.message); }
    const db = getFirestore(app);
    const storage = getStorage(app);
    const machinesCollectionRef = collection(db, "machines");

    let localMachinesCache = [];
    let currentLoggedInUser = '';
    let isUserAdmin = false;
    let isUserManager = false;

    let userLoginCredentials = { username: 'HLP', password: 'HLP' };
    let adminLoginCredentials = { username: 'HLP', password: 'MCC' };
    const managerLoginCredentials = { username: 'Manager', password: '421056' };

    let loginBackgroundEl, userManagementBtnEl, managerControlPanelEl, loginErrorDisplayEl, 
        loginScreenEl, mainAppEl, adminFormSectionEl, statsSectionEl, currentUserDisplayEl, userRoleDisplayEl,
        machinesGridEl, noResultsDisplayEl, machineDetailModalEl, modalTitleDisplayEl, modalContentDisplayEl,
        searchInputTextEl, searchFieldSelectEl, imagePreviewEl;
    
    // --- Password Toggle Function ---
    window.togglePasswordVisibility = function(fieldId, toggleButton) {
        const passwordField = document.getElementById(fieldId);
        if (!passwordField) return;
        if (passwordField.type === "password") {
            passwordField.type = "text";
            toggleButton.textContent = "📖"; 
        } else {
            passwordField.type = "password";
            toggleButton.textContent = "👁️";
        }
    }
    
    async function loadMachinesFromFirestore() {
        try {
            const querySnapshot = await getDocs(machinesCollectionRef);
            localMachinesCache = querySnapshot.docs.map(docSnapshot => ({ ...docSnapshot.data(), firestoreDocId: docSnapshot.id }));
        } catch (error) {
            console.error("Error loading machines:", error); localMachinesCache = [];
            alert("Could not load machine data. Check console.");
        }
        updateStatsDisplay();
        renderMachinesGrid(localMachinesCache);
    }

    window.handleLogin = function() {
        const usernameInput = document.getElementById('loginUsername').value;
        const passwordInput = document.getElementById('loginPassword').value;
        
        isUserAdmin = false; isUserManager = false; loginErrorDisplayEl.style.display = 'none';

        if (usernameInput === userLoginCredentials.username && passwordInput === userLoginCredentials.password) {
            currentLoggedInUser = userLoginCredentials.username;
        } else if (usernameInput === adminLoginCredentials.username && passwordInput === adminLoginCredentials.password) {
            currentLoggedInUser = `${adminLoginCredentials.username} (Admin)`; isUserAdmin = true;
        } else if (usernameInput === managerLoginCredentials.username && passwordInput === managerLoginCredentials.password) {
            currentLoggedInUser = `${managerLoginCredentials.username} (Manager)`; isUserManager = true;
        } else {
            loginErrorDisplayEl.textContent = 'Invalid credentials.'; loginErrorDisplayEl.style.display = 'block';
            setTimeout(() => { loginErrorDisplayEl.style.display = 'none'; }, 3000); return;
        }
        showMainApplicationView();
    }

    async function showMainApplicationView() {
        loginScreenEl.classList.add('hidden');
        if (loginBackgroundEl) loginBackgroundEl.classList.add('hidden');
        mainAppEl.classList.remove('hidden');
        document.body.style.background = 'linear-gradient(135deg, #2c3e50 0%, #34495e 100%)';
        updateUserInterfaceElements();
        await loadMachinesFromFirestore();
    }

    function updateUserInterfaceElements() {
        currentUserDisplayEl.textContent = currentLoggedInUser;
        managerControlPanelEl.classList.add('hidden'); userManagementBtnEl.classList.add('hidden');
        adminFormSectionEl.classList.add('hidden'); statsSectionEl.classList.add('hidden');

        if (isUserManager) {
            userRoleDisplayEl.textContent = 'Manager'; userRoleDisplayEl.style.background = 'rgba(142, 68, 173, 0.2)'; userRoleDisplayEl.style.borderColor = '#8e44ad';
            statsSectionEl.classList.remove('hidden'); userManagementBtnEl.classList.remove('hidden');
        } else if (isUserAdmin) {
            userRoleDisplayEl.textContent = 'Administrator'; userRoleDisplayEl.style.background = 'rgba(231,76,60,0.2)'; userRoleDisplayEl.style.borderColor = '#e74c3c';
            adminFormSectionEl.classList.remove('hidden'); statsSectionEl.classList.remove('hidden');
        } else { 
            userRoleDisplayEl.textContent = 'User'; userRoleDisplayEl.style.background = 'rgba(52,152,219,0.2)'; userRoleDisplayEl.style.borderColor = '#3498db';
        }
    }

    window.toggleManagerPanel = function() {
        if (!isUserManager) return; managerControlPanelEl.classList.toggle('hidden');
        if (!managerControlPanelEl.classList.contains('hidden')) {
            document.getElementById('manageUserUsername').value = userLoginCredentials.username; document.getElementById('manageUserPassword').value = '';
            document.getElementById('manageAdminUsername').value = adminLoginCredentials.username; document.getElementById('manageAdminPassword').value = '';
            document.getElementById('credentialUpdateStatus').textContent = '';
        }
    }

    window.saveManagedCredentials = function() {
        if (!isUserManager) return;
        const newUserPass = document.getElementById('manageUserPassword').value;
        const newAdminPass = document.getElementById('manageAdminPassword').value;
        let updatesMade = false;
        if (newUserPass) { userLoginCredentials.password = newUserPass; updatesMade = true; }
        if (newAdminPass) { adminLoginCredentials.password = newAdminPass; updatesMade = true; }
        const statusDiv = document.getElementById('credentialUpdateStatus');
        statusDiv.textContent = updatesMade ? 'Credentials updated for session!' : 'No new passwords entered.';
        statusDiv.style.color = updatesMade ? '#27ae60' : '#f39c12';
        document.getElementById('manageUserPassword').value = ''; document.getElementById('manageAdminPassword').value = '';
        setTimeout(() => { statusDiv.textContent = ''; }, 4000);
    }

    function updateStatsDisplay() {
        document.getElementById('totalMachinesDisplay').textContent = localMachinesCache.length;
        document.getElementById('activeMachinesDisplay').textContent = localMachinesCache.filter(m => m.status === 'Active').length;
        document.getElementById('maintenanceMachinesDisplay').textContent = localMachinesCache.filter(m => m.status === 'Maintenance').length;
    }
    
    window.handleSearchMachines = function() {
        const searchTerm = searchInputTextEl.value.trim().toLowerCase();
        const searchField = searchFieldSelectEl.value;
        if (searchTerm === '') { renderMachinesGrid(localMachinesCache); return; }
        const filtered = localMachinesCache.filter(machine => {
            const check = (val) => val && String(val).toLowerCase().includes(searchTerm);
            if (searchField === "all") { // Check a predefined set of important fields for "all"
                 return (check(machine.id)) || (check(machine.equipTagNo)) || (check(machine.equipDesc)) ||
                       (check(machine.panelNumber)) || (check(machine.mccLocation)) ||
                       (check(machine.motorDescription_np)) || (check(machine.manufacturer_np)) ||
                       (check(machine.status));
            }
            return Object.prototype.hasOwnProperty.call(machine, searchField) && check(machine[searchField]);
        });
        renderMachinesGrid(filtered);
    }

    window.handleShowAllMachines = function() {
        searchInputTextEl.value = ''; searchFieldSelectEl.value = 'all';
        renderMachinesGrid(localMachinesCache);
    }

    function renderMachinesGrid(machinesToList) {
        machinesGridEl.innerHTML = '';
        if (machinesToList.length === 0) {
            noResultsDisplayEl.textContent = searchInputTextEl.value.trim() !== '' ? 'No machines found matching criteria.' : 'No machines in inventory.';
            noResultsDisplayEl.classList.remove('hidden'); return;
        }
        noResultsDisplayEl.classList.add('hidden');
        machinesToList.forEach(machine => {
            const card = document.createElement('div'); card.className = 'engine-card';
            const clickableArea = document.createElement('div'); clickableArea.className = 'engine-card-clickable-area';
            if (!isUserAdmin) { clickableArea.onclick = () => showMachineDetailView(machine.id); }
            
            clickableArea.innerHTML = `
                <div class="engine-id">${machine.id || 'N/A'} ${machine.equipTagNo ? `(${machine.equipTagNo})` : ''}</div>
                <div class="engine-image">${machine.image ? `<img src="${machine.image}" alt="Machine Image">` : '📷 No Image'}</div>
                <div class="engine-info">
                    <div class="info-item"><div class="info-label">Description</div><div class="info-value">${machine.equipDesc || 'N/A'}</div></div>
                    <div class="info-item"><div class="info-label">Location</div><div class="info-value">${machine.mccLocation || 'N/A'}</div></div>
                    <div class="info-item"><div class="info-label">Status</div><div class="info-value" style="color: ${getMachineStatusColor(machine.status)}">${machine.status || 'N/A'}</div></div>
                </div>`;
            card.appendChild(clickableArea);
            if (isUserAdmin) {
                const actionsDiv = document.createElement('div'); actionsDiv.className = 'engine-card-actions';
                actionsDiv.innerHTML = `<button class="btn btn-secondary btn-small" onclick="showMachineDetailView('${machine.id}')">Details</button><button class="btn btn-danger btn-small" onclick="promptDeleteMachine('${machine.id}', '${machine.firestoreDocId}')">Delete</button>`;
                card.appendChild(actionsDiv);
            }
            machinesGridEl.appendChild(card);
        });
    }

    function getMachineStatusColor(status) { switch(status) { case 'Active': return '#27ae60'; case 'Maintenance': return '#f39c12'; case 'Inactive': return '#e74c3c'; default: return '#7f8c8d'; }}
    function formatModalDetailItem(label, value, isHtml = false) { if (value === undefined || value === null || String(value).trim() === '') return ''; return `<div class="info-item"><div class="info-label">${label}</div><div class="info-value">${isHtml ? value : String(value).replace(/\n/g, '<br>')}</div></div>`;}

    window.showMachineDetailView = function(machineId) {
        const machine = localMachinesCache.find(m => m.id === machineId);
        if (!machine) { alert("Machine details not found."); return; }
        modalTitleDisplayEl.textContent = `Machine Details - ${machine.id}`;
        let contentHtml = '';
        if (machine.image) { contentHtml += `<div style="text-align: center; margin-bottom:15px;"><img src="${machine.image}" alt="Machine Image" style="max-width: 100%; max-height: 250px; border-radius: 8px;"></div>`; }
        
        // Manually list fields to control order and formatting, and to exclude some (like firestoreDocId)
        contentHtml += `<div class="modal-section-title">Core Identifiers</div>`;
        contentHtml += formatModalDetailItem('Machine ID', machine.id);
        contentHtml += formatModalDetailItem('Panel Number', machine.panelNumber);
        contentHtml += `<div class="modal-section-title">Equipment Information</div>`;
        contentHtml += formatModalDetailItem('Equipment Tag No.', machine.equipTagNo);
        contentHtml += formatModalDetailItem('Equipment Description', machine.equipDesc);
        contentHtml += `<div class="modal-section-title">Motor MCC Data</div>`;
        contentHtml += formatModalDetailItem('Switch Room No.', machine.switchRoomNo);
        contentHtml += formatModalDetailItem('MCC', machine.mcc);
        contentHtml += formatModalDetailItem('MCC Location', machine.mccLocation);
        contentHtml += formatModalDetailItem('MCC Typical', machine.mccTypical);
        contentHtml += formatModalDetailItem('Profibus Address', machine.profibusAddress);
        contentHtml += formatModalDetailItem('Running Application', machine.runningApp);
        contentHtml += formatModalDetailItem('Power (KW)', machine.powerKW_mcc); // Note: property names from your form
        contentHtml += formatModalDetailItem('Current (AMP)', machine.currentAMP_mcc);
        contentHtml += formatModalDetailItem('System Cabinet', machine.systemCabinet);
        // ... Add ALL other MCC Data fields
        contentHtml += `<div class="modal-section-title">Motor Name Plate</div>`;
        contentHtml += formatModalDetailItem('Motor Description', machine.motorDescription_np);
        contentHtml += formatModalDetailItem('Type', machine.type_np);
        // ... Add ALL other Name Plate fields
        contentHtml += `<div class="modal-section-title">Replacements History</div>`;
        contentHtml += formatModalDetailItem('Date 1', machine.replacementDate1);
        // ... Add other replacement dates
        contentHtml += `<div class="modal-section-title">Breakers Related To</div>`;
        // ... Add breaker info
        contentHtml += `<div class="modal-section-title">Additional Info</div>`;
        // ... Add MOT.No, Asset No, etc.
        contentHtml += `<div class="modal-section-title">System & Maintenance</div>`;
        contentHtml += formatModalDetailItem('Status', `<span style="color: ${getMachineStatusColor(machine.status)}">${machine.status}</span>`, true);
        contentHtml += formatModalDetailItem('General Notes', machine.notes_general);

        modalContentDisplayEl.innerHTML = contentHtml;
        machineDetailModalEl.classList.remove('hidden'); machineDetailModalEl.style.display = 'flex';
    };
    window.closeMachineDetailModal = function() { machineDetailModalEl.classList.add('hidden');};
    window.previewImage = function(event) { if (event.target.files && event.target.files[0]) { const reader = new FileReader(); reader.onload = (e) => { imagePreviewEl.innerHTML = `<img src="${e.target.result}" alt="Preview" style="max-width: 200px; max-height: 150px; border-radius: 8px;">`; }; reader.readAsDataURL(event.target.files[0]); } else { imagePreviewEl.innerHTML = ''; }};
    
    window.handleAddMachine = async function() {
        if (!isUserAdmin) { alert('Access denied.'); return; }
        const machineId = document.getElementById('machineIdInput').value.trim();
        if (!machineId) { alert('Machine ID required.'); return; }
        if (localMachinesCache.some(m => m.id === machineId)) { alert('Machine ID exists.'); return; }
        
        const getVal = id => document.getElementById(id)?.value.trim() || ''; // Helper to get form values
        const getNum = id => parseFloat(document.getElementById(id)?.value) || null;
        const getInt = id => parseInt(document.getElementById(id)?.value) || null;

        const newMachine = { 
            id: machineId, 
            panelNumber: getVal('panelNumberInput'), equipTagNo: getVal('equipTagNoInput'), equipDesc: getVal('equipDescInput'),
            switchRoomNo: getVal('switchRoomNoInput'), mcc: getVal('mccInput'), mccLocation: getVal('mccLocationInput'),
            mccTypical: getVal('mccTypicalInput'), profibusAddress: getVal('profibusAddressInput'), runningApp: getVal('runningAppInput'),
            powerKW_mcc: getNum('powerKWmccInput'), currentAMP_mcc: getNum('currentAMPmccInput'), systemCabinet: getVal('systemCabinetInput'),
            segmentNo: getVal('segmentNoInput'), redundantNo: getVal('redundantNoInput'), voltage_mcc: getVal('voltagemccInput'),
            powerCable: getVal('powerCableInput'), fieldControlCable: getVal('fieldControlCableInput'), rtdCable: getVal('rtdCableInput'),
            heaterCable: getVal('heaterCableInput'), estimatedLength_mcc: getVal('estimatedLengthmccInput'), mvCtRatio_mcc: getVal('mvCtRatiomccInput'),
            hhmFusesSiba_mcc: getVal('hhmFusesSibamccInput'), 
            motorDescription_np: getVal('motorDescriptionNpInput'), type_np: getVal('typeNpInput'), frame_np: getVal('frameNpInput'),
            fla_np: getVal('flaNpInput'), rpm_np: getInt('rpmNpInput'), hpKw_np: getVal('hpKwNpInput'),
            manufacturer_np: getVal('manufacturerNpInput'), volts_np: getVal('voltsNpInput'), couplingType_np: getVal('couplingTypeNpInput'),
            mountingType_np: getVal('mountingTypeNpInput'), jBoxSide_np: getVal('jBoxSideNpInput'), deBearing_np: getVal('deBearingNpInput'),
            ndeBearing_np: getVal('ndeBearingNpInput'), note_np: getVal('noteNpInput'),
            replacementDate1: getVal('replacementDate1Input'), replacementDate2: getVal('replacementDate2Input'),
            replacementDate3: getVal('replacementDate3Input'), replacementDate4: getVal('replacementDate4Input'),
            breakerEquipDesc1: getVal('breakerEquipDesc1Input'), breakerEquipTag1: getVal('breakerEquipTag1Input'), breakerMccLocation1: getVal('breakerMccLocation1Input'),
            breakerEquipDesc2: getVal('breakerEquipDesc2Input'), breakerEquipTag2: getVal('breakerEquipTag2Input'), breakerMccLocation2: getVal('breakerMccLocation2Input'),
            motNo_add: getVal('motNoAddInput'), assetNo_add: getVal('assetNoAddInput'), hlpFeedbackNote_add: getVal('hlpFeedbackNoteAddInput'),
            status: document.getElementById('statusInput').value, notes_general: getVal('generalNotesInput'), image: ''
        };
        
        const imageFile = document.getElementById('machineImageInput').files[0];
        const saveData = async (dataToSave) => {
            try { await setDoc(doc(db, "machines", dataToSave.id), dataToSave); await loadMachinesFromFirestore(); clearAdminForm(); alert('Machine added successfully!'); searchInputTextEl.value = dataToSave.id; handleSearchMachines(); }
            catch (e) { console.error("Add machine error:", e); alert('Failed to add machine. Ensure Machine ID is unique.'); }
        };

        if (imageFile) {
            const filePath = `machine_images/${machineId}-${Date.now()}-${imageFile.name}`;
            const fileRef = storageRef(storage, filePath);
            const uploadTask = uploadBytesResumable(fileRef, imageFile);
            uploadTask.on('state_changed', 
                (s) => { console.log(`Upload: ${ (s.bytesTransferred/s.totalBytes*100).toFixed(0) }%`); }, 
                (err) => { console.error(err); alert("Image upload failed. Saving without image."); saveData(newMachine);}, 
                async () => { 
                    try { newMachine.image = await getDownloadURL(uploadTask.snapshot.ref); await saveData(newMachine); }
                    catch(e) { console.error(e); alert("Failed to get image URL. Saving without image."); await saveData(newMachine); }
                }
            );
        } else { await saveData(newMachine); }
    };
    window.clearAdminForm = function() { const form = adminFormSectionEl.querySelector('.admin-form'); if(form) form.reset(); if(imagePreviewEl) imagePreviewEl.innerHTML = ''; };
    
    window.promptDeleteMachine = function(machineId, firestoreDocId) { if (!isUserAdmin) { alert("Access Denied."); return; } if (confirm(`Delete machine ${machineId}? This cannot be undone.`)) { deleteMachineFromDb(firestoreDocId); }};
    async function deleteMachineFromDb(firestoreDocId) { if (!isUserAdmin) return; try { await deleteDoc(doc(db, "machines", firestoreDocId)); await loadMachinesFromFirestore(); alert('Machine deleted successfully.'); } catch (e) { console.error("Delete error:", e); alert('Failed to delete machine.'); }};
    
    window.handleLogout = function() {
        mainAppEl.classList.add('hidden'); managerControlPanelEl.classList.add('hidden'); userManagementBtnEl.classList.add('hidden');
        loginScreenEl.classList.remove('hidden'); if (loginBackgroundEl) loginBackgroundEl.classList.remove('hidden');
        document.body.style.background = ''; document.getElementById('loginUsername').value = ''; document.getElementById('loginPassword').value = '';
        currentLoggedInUser = ''; isUserAdmin = false; isUserManager = false; localMachinesCache = [];
        if(typeof updateStatsDisplay === "function") updateStatsDisplay(); 
        if(typeof renderMachinesGrid === "function") renderMachinesGrid([]);
    };

    document.addEventListener('DOMContentLoaded', function() {
        loginBackgroundEl = document.getElementById('loginBackgroundSlideshow');
        userManagementBtnEl = document.getElementById('userManagementBtn');
        managerControlPanelEl = document.getElementById('managerControlPanel');
        loginErrorDisplayEl = document.getElementById('loginErrorDisplay');
        loginScreenEl = document.getElementById('loginScreen');
        mainAppEl = document.getElementById('mainApp');
        adminFormSectionEl = document.getElementById('adminFormSection');
        statsSectionEl = document.getElementById('statsSection');
        currentUserDisplayEl = document.getElementById('currentUserDisplay');
        userRoleDisplayEl = document.getElementById('userRoleDisplay');
        machinesGridEl = document.getElementById('machinesGrid');
        noResultsDisplayEl = document.getElementById('noResultsDisplay');
        machineDetailModalEl = document.getElementById('machineDetailModal');
        modalTitleDisplayEl = document.getElementById('modalTitleDisplay');
        modalContentDisplayEl = document.getElementById('modalContentDisplay');
        searchInputTextEl = document.getElementById('searchInputText');
        searchFieldSelectEl = document.getElementById('searchFieldSelect');
        imagePreviewEl = document.getElementById('imagePreview');

        if (loginScreenEl) { loginScreenEl.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !loginScreenEl.classList.contains('hidden')) { const activeEl = document.activeElement; if ((activeEl.tagName === 'INPUT' || activeEl.tagName === 'BUTTON') && loginScreenEl.contains(activeEl)) handleLogin(); } }); }
        if (machineDetailModalEl) { machineDetailModalEl.addEventListener('click', (e) => { if (e.target === machineDetailModalEl) closeMachineDetailModal(); }); }
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && machineDetailModalEl && !machineDetailModalEl.classList.contains('hidden')) closeMachineDetailModal(); });
        if (loginScreenEl && !loginScreenEl.classList.contains('hidden') && loginBackgroundEl) { loginBackgroundEl.classList.remove('hidden'); document.body.style.background = 'transparent'; } else if (loginBackgroundEl) { loginBackgroundEl.classList.add('hidden');}
    });
</script>
</body>
</html>
